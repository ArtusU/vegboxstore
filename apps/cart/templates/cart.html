{% extends 'base.html' %} {% block title %}Cart | {% endblock %} 

{% block content %}
<div id="cartapp">
	<h1 class="title">Your Cart</h1>
	{% if cart %}
	<div v-if="products.length > 0">
		<div class="table">
			<table class="table is-fullwidth is-striped">
				<thead>
					<th>Product</th>
					<th>Quantity</th>
					<th>Price</th>
					<th></th>
				</thead>
				<tbody>
					<tr v-for="product in products">
						<td>[[product.title]]</td>
						<td>
							<button
								@click="decrementQuantity(product.id, product.quantity, product.price)"
								class="button is-small is-warning"
							>
								-</button
							>[[product.quantity]]<button
								@click="incrementQuantity(product.id, product.quantity, product.price)"
								class="button is-small is-success"
							>
								+
							</button>
						</td>
						<td>[[product.total_price]]</td>
						<td>
							<button
								@click="removeFromCart(product.id)"
								class="button is-small is-danger"
							>
								Remove
							</button>
						</td>
					</tr>
				</tbody>
				<tfoot>
					<tr>
						<td>Total cost:</td>
						<td></td>
						<td></td>
						<td>[[totalCost]]</td>
					</tr>
				</tfoot>
			</table>
		</div>

		<h2 class="title">Contact information</h2>
		<div class="columns">
			<div class="column is-6">
				<div class="field">
					<label>First name</label>

					<div class="control">
						<input class="input" type="text" name="first_name" v-model="first_name">
					</div>
				</div>

				<div class="field">
					<label>Last name</label>

					<div class="control">
						<input class="input" type="text" name="last_name" v-model="last_name">
					</div>
				</div>

				<div class="field">
					<label>E-mail</label>

					<div class="control">
						<input class="input" type="email" name="email" v-model="email">
					</div>
				</div>

				<div class="field">
					<label>Phone</label>

					<div class="control">
						<input class="input" type="text" name="phone" v-model="phone">
					</div>
				</div>
			</div>

			<div class="column is-6">
				<div class="field">
					<label>Address</label>

					<div class="control">
						<input class="input" type="text" name="address" v-model="address">
					</div>
				</div>

				<div class="field">
					<label>Postcode</label>

					<div class="control">
						<input class="input" type="text" name="postcode" v-model="postcode">
					</div>
				</div>

				<div class="field">
					<label>City</label>

					<div class="control">
						<input class="input" type="text" name="city" v-model="city">
					</div>
				</div>
			</div>
		</div>
					
		<div class="field">
			<div class="control">
				<button class="button is-primary" v-on:click="buy('stripe')">Stripe</button>
				<button class="button is-primary" v-on:click="buy()">PayPal</button>
				<div id="paypal-button-container" class="mt-4"></div>
			</div>
		</div>
	</div>
	<p v-else>Your cart is empty!</p>
	{% else %}
	<p>Cart is empty.</p>
	{% endif %}

	<div v-if="errors.length > 0">
		<article class="message is-danger"
			v-for="error in errors"
		>
			<div class="message-header">
				<p>Error</p>
			</div>
			<div class="message-body">
				[[ error ]]
			</div>
		</article>
	</div>
</div>
{% endblock content %} 

{% block scripts %}
<script type="application/javascript" src="https://js.stripe.com/v3/"></script>
<script>
	var productapp = new Vue({
	    el: '#cartapp',
	    delimiters: ['[[', ']]'],
	    store: store,
	    data () {
	        return {
				errors: [],
				first_name: '',
                last_name: '',
                email: '',
                phone: '',
                address: '',
                postcode: '',
                city: '',
	            products: [{{ productsstring|safe }}],
	        }
	    },
	       computed: {
	           numItems: function() {
	               return store.state.numItems
	           },
	           totalCost: function() {
	               return store.state.totalCost
	           },
	       },
	    methods: {
			validateForm() {
                this.errors = [];

                if (this.first_name === '') {
                    this.errors.push('First name is empty');
                }

                if (this.last_name === '') {
                    this.errors.push('Last name is empty');
                }

                if (this.email === '') {
                    this.errors.push('Email is empty');
                }

                if (this.address === '') {
                    this.errors.push('Address is empty');
                }

                if (this.postcode === '') {
                    this.errors.push('Postcode is empty');
                }

                if (this.city === '') {
                    this.errors.push('City is empty');
                }

                if (this.phone === '') {
                    this.errors.push('Phone is empty');
                }

                return this.errors.length;
            },
			buy() {
				console.log('buy stripe')
				var data = {
                    'first_name': this.first_name,
                    'last_name': this.last_name,
                    'email': this.email,
                    'phone': this.phone,
                    'address': this.address,
                    'postcode': this.postcode,
                    'city': this.city
                };
				if (this.validateForm() === 0) {
					var stripe = Stripe('{{ pub_key }}');

					fetch('{% url 'create_checkout_session' %}', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': '{{ csrf_token }}'
						},
						credentials: 'same-origin',
					})
					.then(function(response) {
						return response.json()
					})
					.then(function(session) {
						return stripe.redirectToCheckout({ 'sessionId': session.session.id });
					})
					.then(function(result) {
						if (result.error) {
							alert(result.error.massage);
						}
					})
					.catch(function(error) {
						console.log('Error:', error);
					});
				}
			},
				
			submitForm() {
				console.log('Submit Form');
				var data = {
					'first_name': this.first_name,
					'last_name': this.last_name,
					'email': this.email,
					'phone': this.phone,
					'address': this.address,
					'city': this.city,
					'postcode': this.postcode,
				};
				fetch('/api/checkout/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then((response) =>{
					console.log('Success');
                    console.log(response);
					
					window.location.href = '/';
                })
                .catch(function (error) {
                    console.log('Error 2');
                    console.log(error);
                })
			},

	        decrementQuantity(product_id, quantity, price) {
	            console.log('decrementQuantity product_id:', product_id);
	            var data = {
	                'product_id': product_id,
	                'update': true,
	                'quantity': parseInt(quantity) - 1
	            };
                console.log(price);
				
				if (parseInt(quantity) -1 === 0) {
					this.removeFromCart(product_id);
				} else {
					store.commit('increment', -1);
					store.commit('changeTotalCost', -parseFloat(price));

					fetch('/api/add_to_cart/', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': '{{ csrf_token }}'
						},
						credentials: 'same-origin',
						body: JSON.stringify(data)
					})
					.then((response) => {
						console.log(response)

						for (var i=0; i<this.products.length; i++) {
							var product = this.products[i];
							
							if (product.id === product_id) {
								this.products[i].quantity = parseInt(this.products[i].quantity) -1;
								this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
							}
						}

					})
					.catch(function (error) {
						console.log('Error 2');
						console.log(error);
					})
				}
	        },

	        incrementQuantity(product_id, quantity, price) {
	            console.log('Product_id:', product_id);

	            var data = {
	                'product_id': product_id,
	                'update': true,
	                'quantity': parseInt(quantity) + 1
	            };
	            store.commit('increment', 1);
	               store.commit('changeTotalCost', parseFloat(price));

	            fetch('/api/add_to_cart/', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                    'X-CSRFToken': '{{ csrf_token }}'
	                },
	                credentials: 'same-origin',
	                body: JSON.stringify(data)
	            })
	            .then((response) => {
	                console.log(response)

	                for (var i = 0; i < this.products.length; i++) {
	                    var product = this.products[i];

	                    if (product.id === product_id) {
	                        this.products[i].quantity = parseInt(this.products[i].quantity) + 1;
	                        this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
	                    }
	                }

	            })
	            .catch(function (error) {
	                console.log('Error 2');
	                console.log(error);
	            })
	        },
			removeFromCart(product_id) {
                console.log('Remove product_id:', product_id);
                var data = {
                    'product_id': product_id
                };    
                fetch('/api/remove_from_cart/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(data)
                })
                .then((response) => {
                    console.log(response)

                    this.products = this.products.filter(product => product.id !== product_id)
                })
                .catch(function (error) {
                    console.log('Error 2');
                    console.log(error);
                })
            }

	    }
	})
</script>
{% endblock scripts %}
