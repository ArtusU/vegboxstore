{% extends 'base.html' %} {% block title %}Cart | {% endblock %} 

{% block content %}
<div id="cartapp">
	<h1 class="title">Your Cart</h1>
	{% if cart %}
	<div class="table">
		<table class="table">
			<thead>
				<th>Product</th>
				<th>Quantity</th>
				<th>Price</th>
				<th></th>
			</thead>
			<tbody>
				<tr v-for="product in products">
					<td>[[product.title]]</td>
					<td>
						<button
							@click="decrementQuantity(product.id, product.quantity, product.price)"
							class="button is-small is-warning"
						>
							-</button
						>[[product.quantity]]<button
							@click="incrementQuantity(product.id, product.quantity, product.price)"
							class="button is-small is-success"
						>
							+
						</button>
					</td>
					<td>[[product.total_price]]</td>
					<td>
						<button
							@click="removeFromCart(product.id)"
							class="button is-small is-danger"
						>
							Remove
						</button>
					</td>
				</tr>
			</tbody>
			<tfoot>
				<tr>
					<td>Total cost:</td>
					<td></td>
					<td></td>
					<td>[[totalCost]]</td>
				</tr>
			</tfoot>
		</table>
		<h2 class="title">Contact information</h2>
			<div class="columns">
				<div class="column is-6">
					<div class="field">
						<label>First name</label>

						<div class="control">
							<input class="input" type="text" name="first_name" v-model="first_name">
						</div>
					</div>

					<div class="field">
						<label>Last name</label>

						<div class="control">
							<input class="input" type="text" name="last_name" v-model="last_name">
						</div>
					</div>

					<div class="field">
						<label>E-mail</label>

						<div class="control">
							<input class="input" type="email" name="email" v-model="email">
						</div>
					</div>

					<div class="field">
						<label>Phone</label>

						<div class="control">
							<input class="input" type="text" name="phone" v-model="phone">
						</div>
					</div>
				</div>

				<div class="column is-6">
					<div class="field">
						<label>Address</label>

						<div class="control">
							<input class="input" type="text" name="address" v-model="address">
						</div>
					</div>

					<div class="field">
						<label>Postcode</label>

						<div class="control">
							<input class="input" type="text" name="postcode" v-model="postcode">
						</div>
					</div>

					<div class="field">
						<label>City</label>

						<div class="control">
							<input class="input" type="text" name="city" v-model="city">
						</div>
					</div>
				</div>
			</div>
	</div>
	{% else %}
	<p>Your cart is empty.</p>
	{% endif %}
</div>
{% endblock content %} 

{% block scripts %}
<script>
	var productapp = new Vue({
	    el: '#cartapp',
	    delimiters: ['[[', ']]'],
	    store: store,
	    data () {
	        return {
	            products: [{{ productsstring|safe }}],
	        }
	    },
	       computed: {
	           numItems: function() {
	               return store.state.numItems
	           },
	           totalCost: function() {
	               return store.state.totalCost
	           },

	       },
	    methods: {

	        decrementQuantity(product_id, quantity, price) {
	            console.log('decrementQuantity product_id:', product_id);
	            var data = {
	                'product_id': product_id,
	                'update': true,
	                'quantity': parseInt(quantity) - 1
	            };
                console.log(price);

	            store.commit('increment', -1);
	            store.commit('changeTotalCost', -parseFloat(price));

	            fetch('/api/add_to_cart/', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                    'X-CSRFToken': '{{ csrf_token }}'
	                },
	                credentials: 'same-origin',
	                body: JSON.stringify(data)
	            })
	            .then((response) => {
	                console.log(response)

	                for (var i=0; i<this.products.length; i++) {
	                    var product = this.products[i];

	                    if (product.id === product_id) {
	                        this.products[i].quantity = parseInt(this.products[i].quantity) -1;
	                        this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
	                    }
	                }

	            })
	            .catch(function (error) {
	                console.log('Error 2');
	                console.log(error);
	            })
	        },

	        incrementQuantity(product_id, quantity, price) {
	            console.log('Product_id:', product_id);

	            var data = {
	                'product_id': product_id,
	                'update': true,
	                'quantity': parseInt(quantity) + 1
	            };
	            store.commit('increment', 1);
	               store.commit('changeTotalCost', parseFloat(price));

	            fetch('/api/add_to_cart/', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                    'X-CSRFToken': '{{ csrf_token }}'
	                },
	                credentials: 'same-origin',
	                body: JSON.stringify(data)
	            })
	            .then((response) => {
	                console.log(response)

	                for (var i = 0; i < this.products.length; i++) {
	                    var product = this.products[i];

	                    if (product.id === product_id) {
	                        this.products[i].quantity = parseInt(this.products[i].quantity) + 1;
	                        this.products[i].total_price = parseInt(this.products[i].quantity) * parseFloat(this.products[i].price)
	                    }
	                }

	            })
	            .catch(function (error) {
	                console.log('Error 2');
	                console.log(error);
	            })
	        },

	        removeFromCart(product_id) {
	            console.log('Remove product_id:', product_id);

	            var data = {
	                'product_id': product_id
	            };

	            fetch('/api/remove_from_cart/', {
	                method: 'POST',
	                headers: {
	                    'Content-Type': 'application/json',
	                    'X-CSRFToken': '{{ csrf_token }}'
	                },
	                credentials: 'same-origin',
	                body: JSON.stringify(data)
	            })
	            .then((response) => {
	                console.log(response)
	                this.products = this.products.filter(product => product.id !== product_id)
	            })
	            .catch(function (error) {
	                console.log('Error 2');
	                console.log(error);
	            })
	        }

	    }
	})
</script>
{% endblock scripts %}
